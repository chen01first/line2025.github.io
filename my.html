<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遺產稅規劃試算工具 (修正公式版)</title>
    <style>
        :root {
            --header-blue: #004a99;
            --header-text: white;
            --bg-grey: #f2f2f2;
            --bg-yellow: #fff2cc;
            --border-color: #cccccc;
            --highlight-red: #d9534f;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ededed;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* RWD 佈局 */
        .grid-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .grid-wrapper { grid-template-columns: 5fr 5fr; }
        }

        .table-responsive { width: 100%; overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 320px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }

        .header-blue { background-color: var(--header-blue); color: var(--header-text); font-weight: bold; }
        .bg-grey { background-color: var(--bg-grey); }
        .bg-yellow { background-color: var(--bg-yellow); font-weight: bold; }
        .text-right { text-align: right !important; }
        .text-red { color: var(--highlight-red); font-weight: bold; }
        .text-large { font-size: 1.3rem; font-weight: bold; }

        /* 2倍寬輸入框 */
        input[type="number"] { padding: 8px; border: 1px solid #aaa; border-radius: 4px; text-align: right; }
        .input-large { width: 300px; max-width: 100%; color: var(--header-blue); font-size: 1.1rem; }
        .input-count { width: 60px; text-align: center; }

        .formula-note { font-size: 0.85rem; color: #666; margin-top: 10px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="grid-wrapper">
        
        <div class="left-panel">
            <div class="table-responsive">
                <table>
                    <tr>
                        <th class="header-blue" width="30%">預計<br>淨資產</th>
                        <td class="bg-yellow text-right">
                            <input type="number" id="totalAssets" class="input-large" value="140000000"> 元
                        </td>
                    </tr>
                    <tr>
                        <th class="bg-grey">扣除免稅額<br>(已扣除)</th>
                        <td class="bg-grey text-large"><span id="displayTotalDeduction">2136</span> 萬</td>
                    </tr>
                    <tr>
                        <th class="bg-grey">遺產稅<br>(稅率 <span id="estateTaxRateDisplay">20%</span>)</th>
                        <td class="bg-grey text-large text-red"><span id="estateTaxResult">1623</span> 萬</td>
                    </tr>
                </table>
            </div>

            <div class="table-responsive">
                <table>
                    <tr>
                        <th class="header-blue" width="30%">預計<br>規劃稅源</th>
                        <td colspan="3" class="bg-yellow text-right">
                            <input type="number" id="planAmount" class="input-large" value="10000000"> 元
                        </td>
                    </tr>
                    <tr class="header-blue">
                        <th>規劃項目</th>
                        <th>贈與</th>
                        <th>有規劃<br>(無列入遺產)</th>
                        <th>有規劃<br>(有列入遺產)</th>
                    </tr>
                    <tr>
                        <th class="bg-grey">保障倍數</th>
                        <td>0</td>
                        <td class="bg-yellow text-red">
                            <input type="number" id="insuranceMultiplier" class="input-count" value="2.3" step="0.1">
                        </td>
                        <td class="bg-grey"><span id="displayMultiplier">2.3</span></td>
                    </tr>
                    <tr>
                        <th class="bg-grey">稅率 /<br>應納稅額</th>
                        <td>贈與稅 10%<br><span id="giftTaxResult">76萬</span></td>
                        <td>-</td>
                        <td class="bg-grey">遺產稅 <span id="planEstateTaxRate">20%</span><br><span id="planEstateTaxResult">460萬</span></td>
                    </tr>
                    <tr>
                        <th class="bg-grey">最後<br>預留金額</th>
                        <td class="text-large"><span id="giftFinalAmount">925萬</span></td>
                        <td class="bg-grey text-large text-red"><span id="planNoEstateFinalAmount">2300萬</span></td>
                        <td class="bg-grey text-large"><span id="planYesEstateFinalAmount">1840萬</span></td>
                    </tr>
                </table>
            </div>
            <div class="formula-note">
                <strong>修正後公式說明：</strong><br>
                1. 應納遺產稅 = (淨資產 - 扣除額) × 20% - 750萬<br>
                2. 保障規劃稅額 = (規劃金額 × 保障倍數) × 遺產稅率<br>
                3. 最後預留金額 = (規劃金額 × 保障倍數) - 應納稅額
            </div>
        </div>

        <div class="right-panel">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr class="header-blue">
                            <th colspan="4">遺產稅扣除額人數輸入</th>
                        </tr>
                        <tr class="bg-grey">
                            <th>項目</th>
                            <th>基準(萬)</th>
                            <th>人數</th>
                            <th>小計(萬)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>遺產免稅額</td><td>1333</td><td>基準</td><td>1333</td></tr>
                        <tr>
                            <td>配偶扣除</td><td>553</td>
                            <td class="bg-yellow"><input type="number" id="countSpouse" class="input-count" value="1" min="0" max="1"></td>
                            <td><span id="subSpouse">553</span></td>
                        </tr>
                        <tr>
                            <td>直系卑親屬</td><td>56</td>
                            <td class="bg-yellow"><input type="number" id="countChild" class="input-count" value="2" min="0"></td>
                            <td><span id="subChild">112</span></td>
                        </tr>
                        <tr>
                            <td>父母扣除</td><td>138</td>
                            <td class="bg-yellow"><input type="number" id="countParent" class="input-count" value="0" min="0" max="2"></td>
                            <td><span id="subParent">0</span></td>
                        </tr>
                        <tr><td>喪葬費</td><td>138</td><td>基準</td><td>138</td></tr>
                        <tr class="header-blue">
                            <td colspan="3" class="text-right">總計扣除額(萬)：</td>
                            <td class="text-large"><span id="totalDeductionCalc">2136</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-responsive">
                <table style="font-size: 0.85rem;">
                    <tr class="header-blue"><th colspan="4">級距基準表 (106年5月12日起適用)</th></tr>
                    <tr class="bg-grey"><td>稅目</td><td>級距</td><td>稅率</td><td>累進差額</td></tr>
                    <tr><td rowspan="3">遺產稅</td><td>5000萬以下</td><td>10%</td><td>0</td></tr>
                    <tr><td>5000萬~1億</td><td>15%</td><td>250萬</td></tr>
                    <tr><td>超過1億</td><td>20%</td><td>750萬</td></tr>
                    <tr style="border-top: 2px solid #999;"><td rowspan="3">贈與稅</td><td>2500萬以下</td><td>10%</td><td>0</td></tr>
                    <tr><td>2500萬~5000萬</td><td>15%</td><td>125萬</td></tr>
                    <tr><td>超過5000萬</td><td>20%</td><td>375萬</td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const D_BASE = 13330000, D_FUNERAL = 1380000, G_EXEMPT = 2440000;
    const D_SPOUSE = 5530000, D_CHILD = 560000, D_PARENT = 1380000;

    function toWan(num) { return Math.round(num / 10000); }

    function calculate() {
        const assets = parseFloat(document.getElementById('totalAssets').value) || 0;
        const planAmount = parseFloat(document.getElementById('planAmount').value) || 0;
        const multiplier = parseFloat(document.getElementById('insuranceMultiplier').value) || 0;
        
        const nS = parseInt(document.getElementById('countSpouse').value) || 0;
        const nC = parseInt(document.getElementById('countChild').value) || 0;
        const nP = parseInt(document.getElementById('countParent').value) || 0;

        // 1. 扣除額計算
        document.getElementById('subSpouse').innerText = toWan(nS * D_SPOUSE);
        document.getElementById('subChild').innerText = toWan(nC * D_CHILD);
        document.getElementById('subParent').innerText = toWan(nP * D_PARENT);

        const totalD = D_BASE + D_FUNERAL + (nS * D_SPOUSE) + (nC * D_CHILD) + (nP * D_PARENT);
        const totalDWan = toWan(totalD);
        document.getElementById('totalDeductionCalc').innerText = totalDWan;
        document.getElementById('displayTotalDeduction').innerText = totalDWan;

        // 2. 遺產稅計算 (修正公式)
        const netEstate = assets - totalD;
        let eRate = 0.1, eDiff = 0;
        if (netEstate > 100000000) { eRate = 0.2; eDiff = 7500000; }
        else if (netEstate > 50000000) { eRate = 0.15; eDiff = 2500000; }
        
        const eTax = netEstate > 0 ? (netEstate * eRate - eDiff) : 0;
        document.getElementById('estateTaxRateDisplay').innerText = (eRate * 100) + '%';
        document.getElementById('estateTaxResult').innerText = toWan(eTax);

        // 3. 規劃項目計算
        document.getElementById('displayMultiplier').innerText = multiplier;
        const leveragedVal = planAmount * multiplier;
        
        // 贈與稅 (10% 級距)
        const netGift = planAmount - G_EXEMPT;
        const gTax = netGift > 0 ? (netGift * 0.1) : 0;
        document.getElementById('giftTaxResult').innerText = toWan(gTax) + '萬';
        document.getElementById('giftFinalAmount').innerText = toWan(planAmount - gTax) + '萬';

        // 有規劃(無列入)
        document.getElementById('planNoEstateFinalAmount').innerText = toWan(leveragedVal) + '萬';

        // 有規劃(列入遺產) - 修正公式：(槓桿後價值 * 遺產稅率)
        const planEstateTax = leveragedVal * eRate; 
        document.getElementById('planEstateTaxRate').innerText = (eRate * 100) + '%';
        document.getElementById('planEstateTaxResult').innerText = toWan(planEstateTax) + '萬';
        document.getElementById('planYesEstateFinalAmount').innerText = toWan(leveragedVal - planEstateTax) + '萬';
    }

    document.querySelectorAll('input').forEach(input => input.addEventListener('input', calculate));
    calculate();
</script>

</body>
</html>