<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>蔡老師數字DNA分析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .highlight-box {
            transition: all 0.3s ease;
        }

        .highlight-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 延年樣式 */
        .theme-tag-延年 {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* 橢圓形 */
            font-weight: 600;
            background-color: #a7f3d0;
            /* bg-emerald-200 */
            color: #065f46;
            /* text-emerald-800 */
            font-size: 0.9em;
        }

        /* 伏位延伸樣式 */
        .theme-tag-伏位延伸 {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            /* rounded-md */
            font-weight: 600;
            background-color: #bfdbfe;
            /* bg-blue-200 */
            color: #1e40af;
            /* text-blue-800 */
            font-size: 0.9em;
        }

        /* 其他主題標籤通用樣式 */
        .theme-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.9em;
            background-color: #e0e7ff; /* bg-indigo-100 */
            color: #4338ca; /* text-indigo-700 */
        }
        
        /* 禍害 */
        .theme-tag-禍害 {
            background-color: #fee2e2; /* bg-red-100 */
            color: #991b1b; /* text-red-800 */
        }

        /* 絕命 */
        .theme-tag-絕命 {
            background-color: #ffedd5; /* bg-orange-100 */
            color: #9a3412; /* text-orange-800 */
        }

        /* 六煞 */
        .theme-tag-六煞 {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
        }

        /* 五鬼 */
        .theme-tag-五鬼 {
            background-color: #fce7f3; /* bg-pink-100 */
            color: #9d174d; /* text-pink-800 */
        }

        /* 天醫 */
        .theme-tag-天醫 {
            background-color: #d1fae5; /* bg-green-100 */
            color: #065f46; /* text-green-800 */
        }

        /* 生氣 */
        .theme-tag-生氣 {
            background-color: #e6fffa; /* bg-teal-100 */
            color: #0d9488; /* text-teal-800 */
        }


        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        /* 橋樑標記 */
        .bridge-mark {
            border-top: 1px dashed #d1d5db;
            /* border-gray-300 */
            color: #9ca3af;
            /* text-gray-400 */
            font-style: italic;
            font-size: 0.8em;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">
    <div class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">蔡老師數字DNA分析工具</h1>
            <p class="text-gray-600 text-lg">輸入號碼後的每一步分析結果</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="tabs flex flex-wrap gap-2 mb-4">
                <button class="tab-btn active px-4 py-2 rounded-lg transition-colors">手機號碼DNA</button>
                <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">有圖有真相</button>
                <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">分享給更多人</button>
            </div>

            <div class="space-y-4">
                <label for="phoneInput" class="block text-lg font-medium">輸入電話號碼：</label>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="tel" id="phoneInput" placeholder="請輸入09開頭的電話號碼 (共10位數字)"
                        class="flex-1 p-3 border border-gray-300 rounded-md text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        maxlength="10" pattern="09\d{8}" />
                    <button id="analyzeBtn"
                        class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors shadow-md">
                        <i class="fas fa-search mr-2"></i>開始分析
                    </button>
                </div>
                <p class="text-sm text-gray-500">* 請輸入正確的10位數手機號碼 (09開頭)</p>
                <p id="errorMessage" class="text-red-500 text-sm hidden">請輸入有效的10位手機號碼，必須以09開頭。</p>
            </div>
        </div>

        <section class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-indigo-700">分析結果</h2>
                <button id="copyResultsBtn" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                    <i class="fas fa-copy mr-1"></i> 複製結果
                </button>
            </div>
            <div id="analysisOutput" class="space-y-4">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-phone-alt text-4xl mb-2"></i>
                    <p>請輸入電話號碼開始分析</p>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">主題統計</h2>
            <div class="relative">
                <textarea id="summaryOutput" readonly
                    class="w-full p-4 border border-gray-300 rounded-md text-base h-32 focus:ring-2 focus:ring-indigo-500"
                    placeholder="統計摘要會顯示在這裡..."></textarea>
                <button id="copySummaryBtn" class="absolute top-2 right-2 text-gray-500 hover:text-indigo-600">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">使用說明</h2>
            <div class="prose prose-indigo max-w-none">
                <ol class="list-decimal pl-5 space-y-2">
                    <li>輸入09開頭的10位數手機號碼</li>
                    <li>分析規則：
                        <ul class="list-disc pl-5 mt-1">
                            <li>從左到右逐步分析2位數組合</li>
                            <li>開頭09的伏位不受影響</li>
                            <li>伏位會受前一個吉凶星的影響</li>
                            <li>數字5會作為2數之間的橋樑</li>
                        </ul>
                    </li>
                    <li>結果會顯示每一步的分析過程和對應主題</li>
                </ol>
            </div>
        </section>
    </div>

    <script>
        const CLOUDFLARE_WORKER_URL = 'https://mid.chen01first.workers.dev/'; // 您的 Cloudflare Worker URL

        class UI {
            constructor() {
                this.phoneInput = document.getElementById('phoneInput');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.analysisOutput = document.getElementById('analysisOutput');
                this.summaryOutput = document.getElementById('summaryOutput');
                this.copyResultsBtn = document.getElementById('copyResultsBtn');
                this.copySummaryBtn = document.getElementById('copySummaryBtn');
                this.errorMessage = document.getElementById('errorMessage');

                this.initEventListeners();
            }

            initEventListeners() {
                this.analyzeBtn.addEventListener('click', this.handleAnalyze.bind(this));
                this.phoneInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleAnalyze();
                    }
                });
                this.copyResultsBtn.addEventListener('click', () => this.copyContent(this.analysisOutput));
                this.copySummaryBtn.addEventListener('click', () => this.copyContent(this.summaryOutput));
                // Add input validation on blur for better UX
                this.phoneInput.addEventListener('blur', this.validateInput.bind(this));
                this.phoneInput.addEventListener('input', this.clearError.bind(this));
            }

            validateInput() {
                const phoneNumber = this.phoneInput.value.trim();
                const isValid = /^(09)\d{8}$/.test(phoneNumber);
                if (!isValid && phoneNumber !== '') {
                    this.errorMessage.classList.remove('hidden');
                    return false;
                } else {
                    this.errorMessage.classList.add('hidden');
                    return true;
                }
            }

            clearError() {
                this.errorMessage.classList.add('hidden');
            }

            async handleAnalyze() {
                this.clearError();
                const phoneNumber = this.phoneInput.value.trim();

                if (!this.validateInput()) {
                    return;
                }

                this.setLoadingState(true);
                try {
                    const response = await this.fetchAnalysis(phoneNumber);
                    if (response.success) {
                        this.renderAnalysisResults(response.data);
                        this.renderSummary(response.data);
                    } else {
                        this.displayError('分析失敗：' + response.error);
                    }
                } catch (error) {
                    console.error('Error fetching analysis:', error);
                    this.displayError('網路請求失敗，請稍後再試。');
                } finally {
                    this.setLoadingState(false);
                }
            }

            async fetchAnalysis(phoneNumber) {
                const headers = new Headers({
                    'Content-Type': 'application/json',
                });

                // Fetch options for POST request
                const fetchOptions = {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ phoneNumber: phoneNumber }),
                };

                const response = await fetch(CLOUDFLARE_WORKER_URL, fetchOptions);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            setLoadingState(isLoading) {
                this.analyzeBtn.disabled = isLoading;
                this.analyzeBtn.innerHTML = isLoading ?
                    '<i class="fas fa-spinner fa-spin mr-2"></i>分析中...' :
                    '<i class="fas fa-search mr-2"></i>開始分析';
                this.phoneInput.disabled = isLoading;
            }

            renderAnalysisResults(results) {
                this.analysisOutput.innerHTML = ''; // Clear previous results

                if (results.length === 0) {
                    this.analysisOutput.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                            <p>沒有分析結果。</p>
                        </div>
                    `;
                    return;
                }

                results.forEach(analysis => {
                    const {
                        step,
                        fullPhoneNumber,
                        displayNumber,
                        displayPair,
                        theme,
                        fiveNumMessage,
                        previousResult
                    } = analysis;

                    // Determine theme tag class
                    let themeClass = 'theme-tag';
                    if (theme.includes('延年')) {
                        themeClass = 'theme-tag-延年';
                    } else if (theme.includes('伏位') && previousResult !== '伏位') {
                        themeClass = 'theme-tag-伏位延伸';
                    } else {
                        // Apply specific colors for other themes if desired, e.g., using a map
                        const themeColorMap = {
                            '天醫': 'theme-tag-天醫',
                            '生氣': 'theme-tag-生氣',
                            '六煞': 'theme-tag-六煞',
                            '禍害': 'theme-tag-禍害',
                            '絕命': 'theme-tag-絕命',
                            '五鬼': 'theme-tag-五鬼',
                            // Add other themes here if they need specific colors beyond default
                        };
                        themeClass = themeColorMap[theme.split('(')[0]] || themeClass; // Use base theme name
                    }


                    const resultHtml = `
                        <div class="highlight-box p-4 border border-gray-200 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 bg-white">
                            <div class="flex-1 text-gray-700">
                                <p class="text-sm text-gray-500 mb-1">步驟 ${step}</p>
                                <p class="text-xl font-semibold mb-2">${fullPhoneNumber}</p>
                                <p class="text-lg">數字組合: <span class="font-bold text-indigo-600">${displayPair}</span></p>
                            </div>
                            <div class="flex-shrink-0 text-right">
                                <span class="${themeClass}">${theme}</span>
                                ${fiveNumMessage ? `<div class="bridge-mark">${fiveNumMessage}</div>` : ''}
                            </div>
                        </div>
                    `;
                    this.analysisOutput.insertAdjacentHTML('beforeend', resultHtml);
                });
            }


            renderSummary(results) {
                const summary = results.map(analysis => {
                    let text = `步驟 ${analysis.step}: ${analysis.fullPhoneNumber} (${analysis.displayPair}) - ${analysis.theme}`;
                    if (analysis.fiveNumMessage) {
                        text += ` (${analysis.fiveNumMessage})`;
                    }
                    return text;
                }).join('\n');
                this.summaryOutput.value = summary;
            }

            copyContent(element) {
                let textToCopy = '';
                if (element.tagName === 'TEXTAREA') {
                    textToCopy = element.value;
                } else {
                    // For analysisOutput, we want to copy visible text, excluding internal HTML tags
                    // A more robust solution might involve iterating through children or using a helper to extract clean text
                    textToCopy = Array.from(element.children)
                        .map(child => child.innerText.trim())
                        .join('\n\n'); // Separate each analysis block with two newlines
                }


                navigator.clipboard.writeText(textToCopy)
                    .then(() => alert('內容已複製到剪貼簿！'))
                    .catch(err => console.error('複製失敗:', err));
            }

            displayError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.remove('hidden');
                this.analysisOutput.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p>${message}</p>
                    </div>
                `;
                this.summaryOutput.value = '';
            }
        }

        // Initialize UI
        document.addEventListener('DOMContentLoaded', () => {
            new UI();
        });
    </script>
</body>

</html>