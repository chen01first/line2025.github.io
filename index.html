<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>蔡老師數字DNA分析工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .highlight-box {
      transition: all 0.3s ease;
    }

    .highlight-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .theme-tag {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 600;
      color: white; /* 預設白色字體 */
      background-color: #6b7280; /* 預設灰色背景 */
    }

    /* 各主題顏色 */
    .theme-天醫 { background-color: #3B82F6; } /* Blue */
    .theme-生氣 { background-color: #10B981; } /* Green */
    .theme-延年 { background-color: #EF4444; } /* Red */
    .theme-伏位 { background-color: #F59E0B; } /* Amber */
    .theme-六煞 { background-color: #6366F1; } /* Indigo */
    .theme-禍害 { background-color: #F472B6; } /* Pink */
    .theme-絕命 { background-color: #7C3AED; } /* Purple */
    .theme-五鬼 { background-color: #06B6D4; } /* Cyan */

    /* 伏位延伸主題的顏色可與主主題相同，或做淡化處理 */
    .theme-伏位-天醫 { background-color: #60A5FA; }
    .theme-伏位-生氣 { background-color: #34D399; }
    .theme-伏位-延年 { background-color: #F87171; }
    .theme-伏位-六煞 { background-color: #818CF8; }
    .theme-伏位-禍害 { background-color: #FBCFE8; }
    .theme-伏位-絕命 { background-color: #A78BFA; }
    .theme-伏位-五鬼 { background-color: #22D3EE; }


    .tab-btn.active {
      background-color: #4f46e5;
      color: white;
    }

    .bridge-mark {
      color: #6b7280;
      font-style: italic;
      font-size: 0.8em;
      margin-top: 0.5rem;
      border-top: 1px dashed #d1d5db; /* 一條線隔開 */
      padding-top: 0.5rem;
    }

    /* RWD 佈局調整 */
    .grid-results {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr)); /* 手機: 2 欄 */
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .grid-results {
        grid-template-columns: repeat(3, minmax(0, 1fr)); /* 平板: 3 欄 */
      }
    }

    @media (min-width: 1024px) {
      .grid-results {
        grid-template-columns: repeat(5, minmax(0, 1fr)); /* 桌機: 5 欄 */
      }
    }

    .number-display {
      font-family: 'Courier New', monospace; /* 固定寬度字體 */
      font-size: 1.25rem;
      font-weight: bold;
    }

    .number-display span {
        background-color: #BFDBFE; /* 淺藍色背景突出顯示 */
        padding: 0 0.15rem;
        border-radius: 0.25rem;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">
  <div class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">蔡老師數字DNA分析工具</h1>
      <p class="text-gray-600 text-lg">輸入號碼後的每一步分析結果</p>
    </header>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="tabs flex flex-wrap gap-2 mb-4">
        <button class="tab-btn active px-4 py-2 rounded-lg transition-colors">手機號碼DNA</button>
        <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">有圖有真相</button>
        <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">分享給更多人</button>
      </div>

      <div class="space-y-4">
        <label for="phoneInput" class="block text-lg font-medium">輸入電話號碼：</label>
        <div class="flex flex-col md:flex-row gap-2">
          <input type="tel" id="phoneInput" placeholder="請輸入09開頭的電話號碼 (共10位數字)"
            class="flex-1 p-3 border border-gray-300 rounded-md text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            maxlength="10" pattern="09\d{8}" />
          <button id="analyzeBtn"
            class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors shadow-md">
            <i class="fas fa-search mr-2"></i>開始分析
          </button>
        </div>
        <p class="text-sm text-gray-500">* 請輸入正確的10位數手機號碼 (09開頭)</p>
        <div id="errorMessage" class="text-red-600 text-sm hidden"></div>
      </div>
    </div>

    <section class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-indigo-700">分析結果</h2>
        <button id="copyResultsBtn" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
          <i class="fas fa-copy mr-1"></i> 複製結果
        </button>
      </div>
      <div id="analysisOutput" class="grid-results">
        <div class="text-center py-8 text-gray-400 col-span-full">
          <i class="fas fa-phone-alt text-4xl mb-2"></i>
          <p>請輸入電話號碼開始分析</p>
        </div>
      </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-indigo-700 mb-4">主題統計</h2>
      <div class="relative">
        <textarea id="summaryOutput" readonly
          class="w-full p-4 border border-gray-300 rounded-md text-base h-32 focus:ring-2 focus:ring-indigo-500"
          placeholder="統計摘要會顯示在這裡..."></textarea>
        <button id="copySummaryBtn" class="absolute top-2 right-2 text-gray-500 hover:text-indigo-600">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-indigo-700 mb-4">使用說明</h2>
      <div class="prose prose-indigo max-w-none">
        <ol class="list-decimal pl-5 space-y-2">
          <li>輸入09開頭的10位數手機號碼</li>
          <li>分析規則：
            <ul class="list-disc pl-5 mt-1">
              <li>從左到右逐步分析2位數組合</li>
              <li>開頭09的伏位不受影響</li>
              <li>伏位會受前一個吉凶星的影響</li>
              <li>數字5會作為2數之間的橋樑</li>
            </ul>
          </li>
          <li>結果會顯示每一步的分析過程和對應主題</li>
        </ol>
      </div>
    </section>
  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https://mid.chen01first.workers.dev/';

    class UIHandler {
        constructor() {
            this.phoneInput = document.getElementById('phoneInput');
            this.analyzeBtn = document.getElementById('analyzeBtn');
            this.analysisOutput = document.getElementById('analysisOutput');
            this.summaryOutput = document.getElementById('summaryOutput');
            this.copyResultsBtn = document.getElementById('copyResultsBtn');
            this.copySummaryBtn = document.getElementById('copySummaryBtn');
            this.errorMessage = document.getElementById('errorMessage');

            this.addEventListeners();
        }

        addEventListeners() {
            this.analyzeBtn.addEventListener('click', () => this.analyzePhoneNumber());
            this.phoneInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.analyzePhoneNumber();
                }
            });
            this.copyResultsBtn.addEventListener('click', () => this.copyToClipboard(this.analysisOutput, '分析結果'));
            this.copySummaryBtn.addEventListener('click', () => this.copyToClipboard(this.summaryOutput, '統計摘要'));
        }

        async analyzePhoneNumber() {
            const phoneNumber = this.phoneInput.value.trim();
            this.errorMessage.textContent = ''; // Clear previous errors
            this.errorMessage.classList.add('hidden');

            if (!phoneNumber) {
                this.showError('請輸入電話號碼。');
                return;
            }

            if (!/^(09)\d{8}$/.test(phoneNumber)) {
                this.showError('請輸入09開頭的10位數字電話號碼。');
                return;
            }

            this.setLoadingState(true);
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber: phoneNumber }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`伺服器錯誤: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('分析結果:', data);
                this.displayAnalysisResults(data.analysisResults, phoneNumber);
                this.displaySummary(data.summary);

            } catch (error) {
                console.error('分析失敗:', error);
                this.showError(`分析過程中發生錯誤: ${error.message}`);
            } finally {
                this.setLoadingState(false);
            }
        }

        setLoadingState(isLoading) {
            this.analyzeBtn.disabled = isLoading;
            this.phoneInput.disabled = isLoading;
            if (isLoading) {
                this.analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>分析中...';
                this.analysisOutput.innerHTML = `<div class="text-center py-8 text-indigo-500 col-span-full">
                                                <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
                                                <p>正在分析，請稍候...</p>
                                            </div>`;
                this.summaryOutput.value = '正在生成摘要...';
            } else {
                this.analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>開始分析';
            }
        }

        showError(message) {
            this.errorMessage.textContent = message;
            this.errorMessage.classList.remove('hidden');
            this.analysisOutput.innerHTML = `<div class="text-center py-8 text-gray-400 col-span-full">
                                            <i class="fas fa-phone-alt text-4xl mb-2"></i>
                                            <p>請輸入電話號碼開始分析</p>
                                        </div>`;
            this.summaryOutput.value = '';
        }

        displayAnalysisResults(results, phoneNumber) {
            this.analysisOutput.innerHTML = ''; // 清空舊結果
            if (results.length === 0) {
                this.analysisOutput.innerHTML = `<div class="text-center py-8 text-gray-400 col-span-full">
                                                <p>無分析結果。</p>
                                            </div>`;
                return;
            }

            results.forEach(result => {
                const { step, start_index, end_index, paired_numbers, theme, fiveNum, pre_step, pre_step_Result } = result;

                const displayPhoneNumber = this.formatPhoneNumber(phoneNumber, start_index, end_index);
                const themeClass = this.getThemeClass(theme);
                const bridgeMark = fiveNum > 0 ? `<div class="bridge-mark">${fiveNum}個5是橋樑</div>` : '';

                const resultCard = `
                    <div class="highlight-box bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-gray-500">步驟 ${step}</span>
                            <span class="theme-tag ${themeClass}">${theme}</span>
                        </div>
                        <div class="number-display text-gray-700 mb-2">${displayPhoneNumber}</div>
                        <p class="text-sm text-gray-600">配對數字: <strong>${paired_numbers}</strong></p>
                        ${bridgeMark}
                        ${pre_step > 0 ? `<p class="text-xs text-gray-500 mt-2">前一步驟結果: ${pre_step_Result}</p>` : ''}
                    </div>
                `;
                this.analysisOutput.innerHTML += resultCard;
            });
        }

        formatPhoneNumber(phoneNumber, startIndex, endIndex) {
            // endIndex 是 1-based, 但 JavaScript 字符串是 0-based
            const start = startIndex - 1;
            const end = endIndex; // 切片不包含 endIndex 的字元

            // 處理 09 開頭且 start_index = 1 的情況，不顯示 09
            let prefix = '';
            let highlighted = '';
            let suffix = '';

            if (startIndex === 1 && paired_numbers === '09') {
                highlighted = phoneNumber.substring(0, 2);
                suffix = phoneNumber.substring(2);
            } else {
                 prefix = phoneNumber.substring(0, start);
                 highlighted = phoneNumber.substring(start, end);
                 suffix = phoneNumber.substring(end);
            }
            return `${prefix}<span title="第 ${startIndex} 到 ${endIndex} 位">${highlighted}</span>${suffix}`;
        }


        getThemeClass(theme) {
            // 移除括號內容，只取主主題來應用顏色
            let baseTheme = theme.split('(')[0];
            // 處理「伏位(xxx延續)」的特殊顏色，但仍基於其延伸的主題
            if (baseTheme.startsWith('伏位')) {
                const match = theme.match(/\((.*?)(延續)?\)/);
                if (match && match[1]) {
                    // 如果是伏位(主題延續)，則用伏位-主題的顏色
                    return `theme-伏位-${match[1]}`;
                }
                return `theme-${baseTheme}`; // 純伏位
            }
            return `theme-${baseTheme}`;
        }

        displaySummary(summary) {
            this.summaryOutput.value = summary;
        }

        async copyToClipboard(element, type) {
            let textToCopy = '';
            if (element.id === 'analysisOutput') {
                // 複製分析結果時，只複製文字內容，移除 HTML 標籤
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = element.innerHTML;
                textToCopy = tempDiv.innerText;
            } else {
                textToCopy = element.value;
            }

            try {
                await navigator.clipboard.writeText(textToCopy);
                alert(`${type}已複製到剪貼簿！`);
            } catch (err) {
                console.error('複製失敗:', err);
                alert(`複製${type}失敗，請手動複製。`);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new UIHandler();
    });
  </script>
</body>

</html>