<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>記錄推薦人</title>
</head>
<body>
  <h2>記錄推薦人</h2>
  <p id="status">正在紀錄推薦人，請稍候...</p>

  <!-- 載入 LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // 👉 一進來先解 liff.state 的參數並重新導向一次
    (function handleLiffState() {
      const url = new URL(window.location.href);
      const liffState = url.searchParams.get("liff.state");

      if (liffState) {
        const newUrl = `${window.location.origin}${window.location.pathname}${liffState}`;
        window.location.replace(newUrl);
      }
    })();
  </script>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxmkRO2ZMJWAUzGdMVlEtdeTSNj5ecqjxTiXl_TRqn8VFBtMLUFWaT7DCe_L1Rvoeu2/exec';

    function getTelFromUrl() {
      const url = new URL(window.location.href);
      return url.searchParams.get("tel");
    }

    async function main() {
      try {
        const tel = getTelFromUrl();
        if (!tel) throw new Error("無法取得電話號碼");

        await liff.init({ liffId: "2007467427-9YQgLR43" });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;

        // 傳送資料到 Google Apps Script
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            tel: tel
          })
        });

        const result = await response.text();
        document.getElementById('status').innerText = '紀錄成功：' + result;
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = '發生錯誤：' + err;
      }
    }

    // 等頁面載入完再執行主程式
    window.addEventListener('load', main);
  </script>
</body>
</html>
