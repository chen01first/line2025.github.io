<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>蔡老師數字DNA分析工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .highlight-box {
      transition: all 0.3s ease;
    }
    .highlight-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .theme-tag {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
    .tab-btn.active {
      background-color: #4f46e5; /* indigo-600 */
      color: white;
    }
    .bridge-mark {
      color: #6b7280; /* gray-500 */
      font-style: italic;
      font-size: 0.8em;
      display: block; /* Make it a block to appear on a new line */
      margin-top: 0.25rem;
    }
    /* Loading Spinner */
    .loader {
      border: 5px solid #f3f3f3; /* Light grey */
      border-top: 5px solid #4f46e5; /* Indigo */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* RWD for results - Rule 8 */
    #analysisOutput {
        display: grid;
        gap: 1rem; /* gap-4 */
    }
    @media (min-width: 640px) { /* sm, usually for tablets in portrait or larger phones */
        #analysisOutput {
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* default to 2 for mobile */
        }
    }
    @media (min-width: 768px) { /* md, usually for tablets */
        #analysisOutput {
            grid-template-columns: repeat(3, minmax(0, 1fr)); /* tablet 3 columns */
        }
    }
    @media (min-width: 1024px) { /* lg, usually for desktops */
        #analysisOutput {
            grid-template-columns: repeat(5, minmax(0, 1fr)); /* desktop 5 columns */
        }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">
  <div class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">蔡老師數字DNA分析工具</h1>
      <p class="text-gray-600 text-lg">輸入號碼後的每一步分析結果</p>
    </header>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="tabs flex flex-wrap gap-2 mb-4">
        <button class="tab-btn active px-4 py-2 rounded-lg transition-colors">手機號碼DNA</button>
        <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">有圖有真相</button>
        <button class="tab-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors">分享給更多人</button>
      </div>

      <div class="space-y-4">
        <div>
            <label for="phoneInput" class="block text-lg font-medium">輸入電話號碼：</label>
            <div class="flex flex-col md:flex-row gap-2 mt-1">
              <input type="tel" id="phoneInput" placeholder="請輸入09開頭的電話號碼 (共10位數字)"
                class="flex-1 p-3 border border-gray-300 rounded-md text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                maxlength="10" />
              <button id="analyzeBtn"
                class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors shadow-md flex items-center justify-center">
                <i class="fas fa-search mr-2"></i>開始分析
              </button>
            </div>
            <p id="inputError" class="text-sm text-red-500 mt-1 h-5"></p> </div>
      </div>
    </div>

    <section id="resultsSection" class="bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-indigo-700">分析結果</h2>
        <button id="copyResultsBtn" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center" title="複製詳細結果">
          <i class="fas fa-copy mr-1"></i> 複製結果
        </button>
      </div>
      <div id="analysisOutputLoading" class="text-center py-8 text-gray-400">
        </div>
      <div id="analysisOutput" class="space-y-4">
        </div>
    </section>

    <section id="summarySection" class="bg-white p-6 rounded-lg shadow-md hidden">
      <h2 class="text-xl font-semibold text-indigo-700 mb-4">主題統計</h2>
      <div class="relative">
        <textarea id="summaryOutput" readonly
          class="w-full p-4 border border-gray-300 rounded-md text-base h-32 focus:ring-2 focus:ring-indigo-500 resize-none"
          placeholder="統計摘要會顯示在這裡..."></textarea>
        <button id="copySummaryBtn" class="absolute top-3 right-3 text-gray-500 hover:text-indigo-600" title="複製統計摘要">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-indigo-700 mb-4">使用說明</h2>
      <div class="prose prose-indigo max-w-none text-gray-700">
        <ol class="list-decimal pl-5 space-y-2">
          <li>輸入09開頭的10位數手機號碼。</li>
          <li>分析規則：
            <ul class="list-disc pl-5 mt-1 space-y-1">
              <li>從左到右逐步分析2位數組合 (基本情況)。</li>
              <li>伏位結果可能會受到前一個分析結果的主題影響，形成 "伏位(主題延伸)"。</li>
              <li>數字 "5" 作為橋樑時，會跳過 "5" 與下一個非 "5" 數字組合分析：
                <ul class="list-circle pl-5 mt-1 space-y-1">
                    <li>例如 <code>X5Y</code>，會分析 <code>XY</code>，標註橋樑 "5"。</li>
                    <li>例如 <code>X55Y</code>，會分析 <code>XY</code>，標註橋樑 "55"。</li>
                </ul>
              </li>
              <li>若橋樑組合分析結果為 "伏位"，同樣可能形成 "伏位(主題延伸)"。</li>
            </ul>
          </li>
          <li>結果會顯示每一步的分析過程和對應主題。</li>
          <li>點擊複製按鈕可方便地分享結果。</li>
        </ol>
      </div>
    </section>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0">
        複製成功!
    </div>

  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https://mid.chen01first.workers.dev/'; // 您的 Cloudflare Worker URL

    const phoneInput = document.getElementById('phoneInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisOutput = document.getElementById('analysisOutput');
    const analysisOutputLoading = document.getElementById('analysisOutputLoading');
    const summaryOutput = document.getElementById('summaryOutput');
    const inputError = document.getElementById('inputError');
    const resultsSection = document.getElementById('resultsSection');
    const summarySection = document.getElementById('summarySection');
    const copyResultsBtn = document.getElementById('copyResultsBtn');
    const copySummaryBtn = document.getElementById('copySummaryBtn');
    const toast = document.getElementById('toast');

    analyzeBtn.addEventListener('click', handleAnalysis);
    phoneInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            handleAnalysis();
        }
    });

    copyResultsBtn.addEventListener('click', () => copyToClipboard(generateResultsTextForCopy(), '詳細結果'));
    copySummaryBtn.addEventListener('click', () => copyToClipboard(summaryOutput.value, '統計摘要'));

    function showToast(message) {
        toast.textContent = message;
        toast.classList.remove('opacity-0');
        setTimeout(() => {
            toast.classList.add('opacity-0');
        }, 2000);
    }

    function copyToClipboard(text, type) {
        if (!text) {
            showToast(`${type}為空，無法複製`);
            return;
        }
        navigator.clipboard.writeText(text)
            .then(() => {
                showToast(`${type}已複製到剪貼簿`);
            })
            .catch(err => {
                console.error('複製失敗: ', err);
                showToast(`${type}複製失敗`);
            });
    }

    function generateResultsTextForCopy() {
        let text = `電話號碼分析結果 (${phoneInput.value}):\n\n`;
        const items = analysisOutput.querySelectorAll('.highlight-box');
        items.forEach(item => {
            const stepText = item.querySelector('p:nth-child(1)').textContent.trim();
            const analysisText = item.querySelector('p:nth-child(2)').textContent.trim();
            const bridgeTextElement = item.querySelector('.bridge-mark');
            const bridgeText = bridgeTextElement ? ` (${bridgeTextElement.textContent.trim()})` : '';
            text += `${stepText}\n${analysisText}${bridgeText}\n\n`;
        });
        return text.trim();
    }


    async function handleAnalysis() {
      const phoneNumber = phoneInput.value.trim();
      inputError.textContent = '';

      // Rule 2: Frontend validation
      if (!/09\d{8}/.test(phoneNumber) || phoneNumber.length !== 10) {
        inputError.textContent = '請輸入正確的10位數手機號碼 (09開頭)。';
        phoneInput.focus();
        resultsSection.classList.add('hidden');
        summarySection.classList.add('hidden');
        return;
      }

      resultsSection.classList.remove('hidden');
      summarySection.classList.remove('hidden');
      analysisOutput.innerHTML = ''; // Clear previous results
      summaryOutput.value = ''; // Clear previous summary
      analysisOutputLoading.innerHTML = '<div class="loader"></div><p>分析中，請稍候...</p>';
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>分析中...';

      try {
        const response = await fetch(CLOUDFLARE_WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ phoneNumber: phoneNumber }),
        });

        analysisOutputLoading.innerHTML = ''; // Clear loader

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: '無法解析錯誤回應' }));
          throw new Error(errorData.message || `請求失敗，狀態碼：${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
            analysisOutput.innerHTML = `<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p>${data.error}</p></div>`;
        } else if (data.analysis && data.analysis.length > 0) {
          renderAnalysisResults(data.analysis, phoneNumber);
          generateAndDisplaySummary(data.analysis);
        } else {
          analysisOutput.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-info-circle text-4xl mb-2"></i><p>沒有分析結果。</p></div>';
        }

      } catch (error) {
        console.error('分析請求錯誤:', error);
        analysisOutputLoading.innerHTML = '';
        analysisOutput.innerHTML = `<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p>分析時發生錯誤：${error.message}</p></div>`;
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>開始分析';
      }
    }

    function renderAnalysisResults(analysisSteps, originalNumber) {
      analysisOutput.innerHTML = ''; // Clear previous content or loader

      // RWD classes are already on #analysisOutput from <style>
      // The parent div #analysisOutput will handle the grid layout

      analysisSteps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'p-4 bg-indigo-50 rounded-md shadow-sm highlight-box';

        const stepNumberPara = document.createElement('p');
        stepNumberPara.className = 'text-sm text-gray-500 mb-1';

        // Highlight logic for the number string
        let highlightedNumber = '';
        const numStr = originalNumber.split('');
        const startIndex = step.startIndex;
        const endIndex = step.endIndex; // This is the index of the second digit in the pair
        const bridgeLength = step.bridge ? step.bridge.length : 0;
        // The actual segment length for highlighting is more complex with bridges
        // For X5Y (pair X,Y), highlight X,5,Y. startIndex is for X, endIndex is for Y
        // For X55Y (pair X,Y), highlight X,5,5,Y.

        let highlightStart = startIndex;
        let highlightEnd = endIndex;

        if (step.bridge) { // If there's a bridge, the highlighted segment includes the bridge
            highlightEnd = startIndex + 1 + bridgeLength + 1 -1; // X + bridge + Y
        } else { // No bridge, just two adjacent digits
            highlightEnd = startIndex + 1;
        }


        for (let i = 0; i < numStr.length; i++) {
          if (i >= highlightStart && i <= highlightEnd) {
            highlightedNumber += `<span class="text-red-600 font-bold">${numStr[i]}</span>`;
          } else {
            highlightedNumber += numStr[i];
          }
        }
        stepNumberPara.innerHTML = `第${step.stepNumber}步：${highlightedNumber}`;

        const analysisPara = document.createElement('p');
        analysisPara.className = 'text-base'; // Increased font size for better readability
        const pairStrong = document.createElement('strong');
        pairStrong.className = 'text-gray-800';
        pairStrong.textContent = `${step.pairToAnalyze}`;
        analysisPara.appendChild(pairStrong);
        analysisPara.append(`: `);

        const themeSpan = document.createElement('span');
        // Add color classes based on theme - you can customize these
        let themeColor = 'text-gray-700'; // Default
        if (step.theme.includes('天醫')) themeColor = 'text-green-700';
        else if (step.theme.includes('生氣')) themeColor = 'text-blue-700';
        else if (step.theme.includes('延年')) themeColor = 'text-yellow-700';
        else if (step.theme.includes('伏位')) themeColor = 'text-purple-700';
        else if (step.theme.includes('六煞')) themeColor = 'text-pink-700';
        else if (step.theme.includes('禍害')) themeColor = 'text-orange-700';
        else if (step.theme.includes('絶命')) themeColor = 'text-red-700';
        else if (step.theme.includes('五鬼')) themeColor = 'text-teal-700';
        themeSpan.className = `${themeColor} font-semibold`;
        themeSpan.textContent = step.theme;
        analysisPara.appendChild(themeSpan);

        stepDiv.appendChild(stepNumberPara);
        stepDiv.appendChild(analysisPara);

        if (step.bridge) {
          const bridgePara = document.createElement('p');
          bridgePara.className = 'bridge-mark';
          bridgePara.textContent = `(橋樑: ${step.bridge})`;
          stepDiv.appendChild(bridgePara);
        }
        analysisOutput.appendChild(stepDiv);
      });
    }

    function generateAndDisplaySummary(analysisSteps) {
        const themeCounts = {};
        analysisSteps.forEach(step => {
            // For "伏位(天醫延伸)", we might want to count "伏位" or "天醫" or both.
            // For this summary, let's count the primary theme.
            let baseTheme = step.theme;
            if (step.theme.includes("伏位(") && step.theme.endsWith("延伸)")) {
                 // E.g., "伏位(天醫延伸)" -> "天醫" for specific count, but also count "伏位"
                let extendedTheme = step.theme.substring(step.theme.indexOf("(") + 1, step.theme.indexOf("延伸)"));
                themeCounts[extendedTheme] = (themeCounts[extendedTheme] || 0) + 1;
                // Also count the "伏位" itself if you want a general伏位 count
                 themeCounts["伏位"] = (themeCounts["伏位"] || 0) + 1;
            } else {
                themeCounts[baseTheme] = (themeCounts[baseTheme] || 0) + 1;
            }
        });

        let summaryText = "主題出現次數：\n";
        const sortedThemes = Object.entries(themeCounts)
            .sort(([, countA], [, countB]) => countB - countA); // Sort by count descending

        if (sortedThemes.length === 0) {
            summaryText = "無分析結果可供統計。";
        } else {
            sortedThemes.forEach(([theme, count]) => {
                summaryText += `${theme}: ${count}次\n`;
            });
        }
        summaryOutput.value = summaryText.trim();
    }

    // Initial placeholder for results until first analysis
    analysisOutput.innerHTML = `
        <div class="text-center py-8 text-gray-400 col-span-full">
            <i class="fas fa-phone-alt text-4xl mb-2"></i>
            <p>請輸入電話號碼開始分析</p>
        </div>`;
  </script>
</body>
</html>