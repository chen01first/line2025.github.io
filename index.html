<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨˜éŒ„æ¨è–¦äºº</title>
</head>
<body>
  <h2>è¨˜éŒ„æ¨è–¦äºº</h2>
  <p id="status">æ­£åœ¨ç´€éŒ„æ¨è–¦äººï¼Œè«‹ç¨å€™...</p>

  <!-- è¼‰å…¥ LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ğŸ‘‰ ä¸€é€²ä¾†å…ˆè§£ liff.state çš„åƒæ•¸ä¸¦é‡æ–°å°å‘ä¸€æ¬¡
    (function handleLiffState() {
      const url = new URL(window.location.href);
      const liffState = url.searchParams.get("liff.state");

      if (liffState) {
        const newUrl = `${window.location.origin}${window.location.pathname}${liffState}`;
        window.location.replace(newUrl);
      }
    })();
  </script>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxmkRO2ZMJWAUzGdMVlEtdeTSNj5ecqjxTiXl_TRqn8VFBtMLUFWaT7DCe_L1Rvoeu2/exec';

    function getTelFromUrl() {
      const url = new URL(window.location.href);
      return url.searchParams.get("tel");
    }

    async function main() {
      try {
        const tel = getTelFromUrl();
        if (!tel) throw new Error("ç„¡æ³•å–å¾—é›»è©±è™Ÿç¢¼");

        await liff.init({ liffId: "2007467427-9YQgLR43" });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;

        // å‚³é€è³‡æ–™åˆ° Google Apps Script
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            tel: tel
          })
        });

        const result = await response.text();
        document.getElementById('status').innerText = 'ç´€éŒ„æˆåŠŸï¼š' + result;
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + err;
      }
    }

    // ç­‰é é¢è¼‰å…¥å®Œå†åŸ·è¡Œä¸»ç¨‹å¼
    window.addEventListener('load', main);
  </script>
</body>
</html>
