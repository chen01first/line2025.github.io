<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>記錄推薦人</title>
</head>
<body>
  <h2>記錄推薦人</h2>
  <p id="status">正在紀錄推薦人，請稍候...</p>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxmkRO2ZMJWAUzGdMVlEtdeTSNj5ecqjxTiXl_TRqn8VFBtMLUFWaT7DCe_L1Rvoeu2/exec';

    // 從網址取得 tel 參數（優先取得 liff.state 中的 tel）
    function getTelFromUrl() {
      const url = new URL(window.location.href);
      const liffState = url.searchParams.get("liff.state");
      if (liffState) {
        // liff.state 通常是 URL encoded 的 query string，需再解析
        const innerParams = new URLSearchParams(liffState);
        return innerParams.get("tel");
      }
      return url.searchParams.get("tel");
    }

    async function main() {
      try {
        const tel = getTelFromUrl();
        if (!tel) throw new Error("無法取得電話號碼");

        await liff.init({ liffId: "2007467427-9YQgLR43" });

        if (!liff.isLoggedIn()) {
          liff.login();
          return; // 登入後不繼續執行
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;

        // 呼叫 Google Apps Script API，POST 資料
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, tel })
        });

        if (!response.ok) {
          throw new Error(`伺服器錯誤，狀態碼：${response.status}`);
        }

        // 預期 GAS 回傳 JSON 格式
        const result = await response.json();

        if (result.status === 'OK') {
          document.getElementById('status').innerText = '紀錄成功！';
        } else {
          document.getElementById('status').innerText = '紀錄失敗：' + (result.message || '未知錯誤');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = '發生錯誤：' + err.message;
      }
    }

    main();
  </script>
</body>
</html>
